<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/head.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/head.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/head.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hxzhouh.com","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"algolia":{"appID":"ZISROINTK6","apiKey":"970a441f5df78225c1ec616cceb70271","indexName":"hxzhouh-blog","hits":{"per_page":10,"labels":null,"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}</script><script src="/js/config.js"></script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9000447749076746"
     crossorigin="anonymous"></script>

    <meta name="description" content="A step-by-step guide to creating and utilizing SAN Certifications for secure gRPC communicationgenerate by DALLE-3">
<meta property="og:type" content="article">
<meta property="og:title" content="Secure Communication with gRPC: From SSL&#x2F;TLS Certification to SAN Certification">
<meta property="og:url" content="https://hxzhouh.com/2024/05/13/golang%20action%20grpc%20san/index.html">
<meta property="og:site_name" content="huizhou92">
<meta property="og:description" content="A step-by-step guide to creating and utilizing SAN Certifications for secure gRPC communicationgenerate by DALLE-3">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://images.hxzhouh.com/blog-images/2024/05/4976a194a8daca00ff6991a866c2ee53.png">
<meta property="article:published_time" content="2024-05-13T01:15:00.000Z">
<meta property="article:modified_time" content="2024-05-13T01:17:50.495Z">
<meta property="article:author" content="huizhou92">
<meta property="article:tag" content="golang">
<meta property="article:tag" content="grpc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images.hxzhouh.com/blog-images/2024/05/4976a194a8daca00ff6991a866c2ee53.png">


<link rel="canonical" href="https://hxzhouh.com/2024/05/13/golang%20action%20grpc%20san/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://hxzhouh.com/2024/05/13/golang%20action%20grpc%20san/","path":"2024/05/13/golang action grpc san/","title":"Secure Communication with gRPC: From SSL/TLS Certification to SAN Certification"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Secure Communication with gRPC: From SSL/TLS Certification to SAN Certification | huizhou92</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2D664FV9XT"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-2D664FV9XT","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="huizhou92" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">huizhou92</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#What-is-SAN"><span class="nav-number">1.</span> <span class="nav-text">What is SAN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-a-SAN-certificate-locally"><span class="nav-number">2.</span> <span class="nav-text">Create a SAN certificate locally</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Testing"><span class="nav-number">3.</span> <span class="nav-text">Testing</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Server-implementation"><span class="nav-number">3.1.</span> <span class="nav-text">Server implementation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Client"><span class="nav-number">3.2.</span> <span class="nav-text">Client</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Conclusion"><span class="nav-number"></span> <span class="nav-text">Conclusion</span></a></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">huizhou92</p>
  <div class="site-description" itemprop="description">Backend engineer with a focus on Golang, cloud computing, data storage, and efficiency tools. Lifelong learner.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">79</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hxzhouh" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxzhouh" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/@piaopiaopig" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;@piaopiaopig" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hxzhouh.com/2024/05/13/golang%20action%20grpc%20san/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huizhou92">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="huizhou92">
      <meta itemprop="description" content="Backend engineer with a focus on Golang, cloud computing, data storage, and efficiency tools. Lifelong learner.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Secure Communication with gRPC: From SSL/TLS Certification to SAN Certification | huizhou92">
      <meta itemprop="description" content="A step-by-step guide to creating and utilizing SAN Certifications for secure gRPC communicationgenerate by DALLE-3">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Secure Communication with gRPC: From SSL/TLS Certification to SAN Certification
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-05-13 09:15:00 / Modified: 09:17:50" itemprop="dateCreated datePublished" datetime="2024-05-13T09:15:00+08:00">2024-05-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/blog/" itemprop="url" rel="index"><span itemprop="name">blog</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>4 mins.</span>
    </span>
</div>

            <div class="post-description">A step-by-step guide to creating and utilizing SAN Certifications for secure gRPC communicationgenerate by DALLE-3</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><img src="https://images.hxzhouh.com/blog-images/2024/05/4976a194a8daca00ff6991a866c2ee53.png" alt="Pasted image 20240512192344"><br><a target="_blank" rel="noopener" href="https://grpc.io/">gRPC</a> is a high-performance RPC framework developed by Google, which by default includes two authentication methods:</p>
<ul>
<li>SSL&#x2F;TLS Authentication</li>
<li>Token-based Authentication<br>Without the activation of the certificate, <code>gRPC</code> service and clients communicate in plaintext, leaving the information at risk of being intercepted by any third party. To ensure <code>gRPC</code> communication is not intercepted, altered or counterfeited by a third party, the server can activate <code>TLS</code> encryption features.<span id="more"></span></li>
</ul>
<blockquote>
<p>This article is first published in the medium MPP plan. If you are a medium user, please follow me in <a target="_blank" rel="noopener" href="https://medium.hxzhouh.com/">medium</a>. Thank you very much.</p>
</blockquote>
<p>Starting from go 1.15 version, <a target="_blank" rel="noopener" href="https://golang.org/doc/go1.15#commonname">depreciation of CommonName</a> began, therefore, it is advised to use <code>SAN</code> certificates. If keys, CSR, and certificates are generated in the previous way through OpenSSL, the following error occurs:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpc error: code = Unavailable desc = connection error: desc = &quot;transport: authentication handshake failed: x509: certificate relies on legacy Common Name field, use SANs instead&quot;|</span><br></pre></td></tr></table></figure>

<h2 id="What-is-SAN"><a href="#What-is-SAN" class="headerlink" title="What is SAN"></a>What is <code>SAN</code></h2><p> <em><strong>SAN (Subject Alternative Name)</strong></em> is defined as an extension in the <code>SSL</code> standard <code>x509</code>. An <code>SSL</code> certificate with the <code>SAN</code> field can expand the domain names it supports, allowing a single certificate to support multiple different domain name resolutions.</p>
<p>Put simply, a SAN certificate can contain multiple complete CN (CommonName), so with a single certificate purchase, you can use it on multiple URLs. For example, the certificate of skype.com, it has many SANs.</p>
<h2 id="Create-a-SAN-certificate-locally"><a href="#Create-a-SAN-certificate-locally" class="headerlink" title="Create a SAN certificate locally"></a>Create a SAN certificate locally</h2><p>Next, we will use an example to generate a client &amp; server bilateral SAN certificate locally.</p>
<p>Assume the hostname of the gRPC server is <code>localhost</code>, and it is required to configure tls bilateral authentication encryption for the communication between the gRPC server and clients.</p>
<ol>
<li>Create <code>openssl.conf</code> to store relevant information</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[req]</span><br><span class="line"></span><br><span class="line">req_extensions = v3_req</span><br><span class="line"></span><br><span class="line">distinguished_name = req_distinguished_name</span><br><span class="line"></span><br><span class="line">prompt = no</span><br><span class="line"></span><br><span class="line">[req_distinguished_name]</span><br><span class="line"></span><br><span class="line">countryName = CN</span><br><span class="line"></span><br><span class="line">stateOrProvinceName = state</span><br><span class="line"></span><br><span class="line">localityName = city</span><br><span class="line"></span><br><span class="line">organizationName = huizhou92</span><br><span class="line"></span><br><span class="line">commonName = hello-world</span><br><span class="line"></span><br><span class="line">[v3_req]</span><br><span class="line"></span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line"></span><br><span class="line">DNS.1 = localhost</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>The content is similar to when creating a ca earlier.</p>
<ol start="2">
<li>Generate ca root certificate</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">openssl req -x509 -newkey rsa:4096 -keyout ca.key -out ca.crt -subj &quot;/CN=localhost&quot; -days 3650 -nodes</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>-nodes is to ignore the password, making it convenient to use, but please note, this may reduce the security of the private key, as anyone can read the unencrypted private key.</p>
<ol start="3">
<li>Generate server certificate</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">openssl req -newkey rsa:2048 -nodes -keyout server.key -out server.csr -subj &quot;/CN=localhost&quot; -config openssl.cnf</span><br><span class="line">openssl x509 -req -in server.csr -out server.crt -CA ca.crt -CAkey ca.key -CAcreateserial -days 365 -extensions v3_req -extfile openssl.cnf</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Generate client certificate</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">openssl req -newkey rsa:2048 -nodes -keyout client.key -out client.csr -subj &quot;/CN=localhost&quot; -config openssl.cnf</span><br><span class="line">openssl x509 -req -in client.csr -out client.crt -CA ca.crt -CAkey ca.key -CAcreateserial -days 365 -extensions v3_req -extfile openssl.cnf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>The final generated result is as follows</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">➜ keys git:(day1) ✗ ls</span><br><span class="line">ca.crt ca.key ca.srl client.crt client.csr client.key openssl.cnf server.crt server.csr server.key</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h2><p>We define the simplest grpc interface.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// helloworld.proto</span><br><span class="line"></span><br><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">option go_package = &quot;./api;api&quot;;</span><br><span class="line"></span><br><span class="line">package api;</span><br><span class="line"></span><br><span class="line">// The greeting service definition.</span><br><span class="line"></span><br><span class="line">service Greeter &#123;</span><br><span class="line"></span><br><span class="line">// Sends a greeting</span><br><span class="line"></span><br><span class="line">rpc SayHello (HelloRequest) returns (HelloReply) &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// The request message containing the user&#x27;s name.</span><br><span class="line"></span><br><span class="line">message HelloRequest &#123;</span><br><span class="line"></span><br><span class="line">string name = 1;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// The response message containing the greetings</span><br><span class="line"></span><br><span class="line">message HelloReply &#123;</span><br><span class="line"></span><br><span class="line">string message = 1;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Server-implementation"><a href="#Server-implementation" class="headerlink" title="Server implementation"></a>Server implementation</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;context&quot;</span>  </span><br><span class="line">    <span class="string">&quot;crypto/tls&quot;</span></span><br><span class="line">    <span class="string">&quot;crypto/x509&quot;</span>    </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>    </span><br><span class="line">    <span class="string">&quot;google.golang.org/genproto/googleapis/rpc/errdetails&quot;</span>    </span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span>    </span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc/codes&quot;</span>    </span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc/credentials&quot;</span>    </span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc/status&quot;</span>    </span><br><span class="line">    <span class="string">&quot;hello-world/api&quot;</span>    </span><br><span class="line">    <span class="string">&quot;log&quot;</span>    </span><br><span class="line">    <span class="string">&quot;net&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os&quot;</span>    </span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> server <span class="keyword">struct</span> &#123;  </span><br><span class="line">    api.UnimplementedGreeterServer  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> SayHello(ctx context.Context, in *api.HelloRequest) (*api.HelloReply, <span class="type">error</span>) &#123;  </span><br><span class="line">    log.Printf(<span class="string">&quot;Received: %v&quot;</span>, in.GetName())  </span><br><span class="line">    <span class="keyword">select</span> &#123;  </span><br><span class="line">    <span class="keyword">case</span> &lt;-ctx.Done():  </span><br><span class="line">       log.Println(<span class="string">&quot;client timeout return&quot;</span>)  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, ErrorWithDetails()  </span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(<span class="number">3</span> * time.Second):  </span><br><span class="line">       <span class="keyword">return</span> &amp;api.HelloReply&#123;Message: <span class="string">&quot;Hello &quot;</span> + in.GetName()&#125;, <span class="literal">nil</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">  </span><br><span class="line">    certificate, err := tls.LoadX509KeyPair(<span class="string">&quot;./keys/server.crt&quot;</span>, <span class="string">&quot;./keys/server.key&quot;</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;Failed to load key pair: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// 通过CA创建证书池  </span></span><br><span class="line">    certPool := x509.NewCertPool()  </span><br><span class="line">    ca, err := os.ReadFile(<span class="string">&quot;./keys/ca.crt&quot;</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;Failed to read ca: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 将来自CA的客户端证书附加到证书池  </span></span><br><span class="line">    <span class="keyword">if</span> ok := certPool.AppendCertsFromPEM(ca); !ok &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;Failed to append ca certificate&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    opts := []grpc.ServerOption&#123;  </span><br><span class="line">       grpc.Creds( <span class="comment">// 为所有传入的连接启用TLS  </span></span><br><span class="line">          credentials.NewTLS(&amp;tls.Config&#123;  </span><br><span class="line">             ClientAuth:   tls.RequireAndVerifyClientCert,  </span><br><span class="line">             Certificates: []tls.Certificate&#123;certificate&#125;,  </span><br><span class="line">             ClientCAs:    certPool,  </span><br><span class="line">          &#125;,  </span><br><span class="line">          )),  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    listen, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, fmt.Sprintf(<span class="string">&quot;0.0.0.0:%d&quot;</span>, <span class="number">50051</span>))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;failed to listen %d port&quot;</span>, <span class="number">50051</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// 通过传入的TLS服务器凭证创建新的gRPC服务实例  </span></span><br><span class="line">    s := grpc.NewServer(opts...)  </span><br><span class="line">    api.RegisterGreeterServer(s, &amp;server&#123;&#125;)  </span><br><span class="line">    log.Printf(<span class="string">&quot;server listening at %v&quot;</span>, listen.Addr())  </span><br><span class="line">    <span class="keyword">if</span> err := s.Serve(listen); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;Failed to serve: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ErrorWithDetails</span><span class="params">()</span></span> <span class="type">error</span> &#123;  </span><br><span class="line">    st := status.Newf(codes.Internal, fmt.Sprintf(<span class="string">&quot;something went wrong: %v&quot;</span>, <span class="string">&quot;api.Getter&quot;</span>))  </span><br><span class="line">    v := &amp;errdetails.PreconditionFailure_Violation&#123; <span class="comment">//errDetails  </span></span><br><span class="line">       Type:        <span class="string">&quot;test&quot;</span>,  </span><br><span class="line">       Subject:     <span class="string">&quot;12&quot;</span>,  </span><br><span class="line">       Description: <span class="string">&quot;32&quot;</span>,  </span><br><span class="line">    &#125;  </span><br><span class="line">    br := &amp;errdetails.PreconditionFailure&#123;&#125;  </span><br><span class="line">    br.Violations = <span class="built_in">append</span>(br.Violations, v)  </span><br><span class="line">    st, _ = st.WithDetails(br)  </span><br><span class="line">    <span class="keyword">return</span> st.Err()  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We directly run the server <code>go run main.go</code></p>
<h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><p>First, we use a request without a certificate</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test_server_SayHello_No_Cert</span><span class="params">(t *testing.T)</span></span> &#123;  </span><br><span class="line">    conn, err := grpc.Dial(<span class="string">&quot;localhost:50051&quot;</span>, grpc.WithTransportCredentials(insecure.NewCredentials()))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;Connect to %s failed&quot;</span>, <span class="string">&quot;localhost:50051&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">defer</span> conn.Close()  </span><br><span class="line">  </span><br><span class="line">    client := api.NewGreeterClient(conn)  </span><br><span class="line">    <span class="comment">// 创建带有超时时间的上下文, cancel可以取消上下文  </span></span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), time.Second*<span class="number">5</span>)  </span><br><span class="line">    <span class="keyword">defer</span> cancel()  </span><br><span class="line">    <span class="comment">// 业务代码处理部分 ...    r, err := client.SayHello(ctx, &amp;api.HelloRequest&#123;Name: &quot;Hello&quot;&#125;)  </span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Printf(<span class="string">&quot;Failed to greet, error: %v&quot;</span>, err)  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       log.Printf(<span class="string">&quot;Greeting: %v&quot;</span>, r.GetMessage())  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Output</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2024/05/12 19:18:51 Failed to greet, error: rpc error: code = Unavailable desc = connection error: desc = &quot;error reading server preface: EOF&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Service is unavailable<br>Now, let’s try a request carrying the certificate</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test_server_SayHello</span><span class="params">(t *testing.T)</span></span> &#123;  </span><br><span class="line">    certificate, err := tls.LoadX509KeyPair(<span class="string">&quot;./keys/client.crt&quot;</span>, <span class="string">&quot;./keys/client.key&quot;</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;Failed to load client key pair, %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    certPool := x509.NewCertPool()  </span><br><span class="line">    ca, err := os.ReadFile(<span class="string">&quot;./keys/ca.crt&quot;</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;Failed to read %s, error: %v&quot;</span>, <span class="string">&quot;./keys/ca.crt&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> ok := certPool.AppendCertsFromPEM(ca); !ok &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;Failed to append ca certs&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    opts := []grpc.DialOption&#123;  </span><br><span class="line">       grpc.WithTransportCredentials(credentials.NewTLS(  </span><br><span class="line">          &amp;tls.Config&#123;  </span><br><span class="line">             ServerName:   <span class="string">&quot;localhost&quot;</span>,  </span><br><span class="line">             Certificates: []tls.Certificate&#123;certificate&#125;,  </span><br><span class="line">             RootCAs:      certPool,  </span><br><span class="line">          &#125;)),  </span><br><span class="line">    &#125;  </span><br><span class="line">    conn, err := grpc.Dial(<span class="string">&quot;localhost:50051&quot;</span>, opts...)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;Connect to %s failed&quot;</span>, <span class="string">&quot;localhost:50051&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">defer</span> conn.Close()  </span><br><span class="line">  </span><br><span class="line">    client := api.NewGreeterClient(conn)  </span><br><span class="line"></span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), time.Second*<span class="number">5</span>)  </span><br><span class="line">    <span class="keyword">defer</span> cancel()  </span><br><span class="line">    r, err := client.SayHello(ctx, &amp;api.HelloRequest&#123;Name: <span class="string">&quot;Hello&quot;</span>&#125;)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Printf(<span class="string">&quot;Failed to greet, error: %v&quot;</span>, err)  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       log.Printf(<span class="string">&quot;Greeting: %v&quot;</span>, r.GetMessage())  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Output</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">=== RUN Test_server_SayHello</span><br><span class="line">2024/05/12 19:20:17 Greeting: Hello Hello</span><br></pre></td></tr></table></figure>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><ol>
<li>We can use tls to implement gRPC encryption communication,</li>
<li>Starting from go1.15, the use of CA is not recommended, instead SAN certificates are utilized.</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/golang/" rel="tag"># golang</a>
              <a href="/tags/grpc/" rel="tag"># grpc</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/05/11/8%20Common%20SQL%20Slow%20Query%20Statements%20and%20How%20to%20Optimize%20Them/" rel="prev" title="8 Common SQL Slow Query Statements and How to Optimize Them">
                  <i class="fa fa-angle-left"></i> 8 Common SQL Slow Query Statements and How to Optimize Them
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments"><div id="twikoo-comments"></div></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">huizhou92</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">91k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">5:30</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/hxzhouh" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.20.0/algoliasearch-lite.umd.js" integrity="sha256-DABVk+hYj0mdUzo+7ViJC6cwLahQIejFvC+my2M/wfM=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.57.0/instantsearch.production.min.js" integrity="sha256-foJtB+Wd0wvvK+VU3KO0/H6CjwSwJfB1RnWlgx0Ov9U=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script>







  

  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.4.0/firebase-app-compat.js" integrity="sha256-kv9gfd+UUnUqqJ2d478LEHzOijuUbZOVdEkuXSMm4qM=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.4.0/firebase-firestore-compat.js" integrity="sha256-sS/hkEB7nn47hhc//PNKfXiRX2YMEe4rBqUIqEhMYA8=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="firestore" type="application/json">{"enable":true,"collection":"articles","apiKey":"AIzaSyBhf1ZiBUIQypQR6JV1MPzZsJkUQHsNK4o","projectId":"blog-views-3d7a8"}</script>
  <script src="/js/third-party/statistics/firestore.js"></script>



<script class="next-config" data-name="twikoo" type="application/json">{"enable":true,"visitor":false,"envId":"https://twikoo.yixiao9206.cn/","el":"#twikoo-comments"}</script>
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.twikoo.el)
    .then(() => NexT.utils.getScript(
      CONFIG.twikoo.jsUrl || 'https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js',
      { condition: window.twikoo }
    ))
    .then(() => {
      twikoo.init(CONFIG.twikoo);
    });
});
</script>
<style>
.post-block, .comments {
  overflow: visible;
}
.tk-owo-emotion {
  display: inline-block;
}
</style>

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2D664FV9XT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2D664FV9XT');
</script>
</body>
</html>
